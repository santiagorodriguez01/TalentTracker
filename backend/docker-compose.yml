version: "3.9"

services:
  mysql:
    image: mysql:8
    container_name: talenttracker_mysql
    environment:
      MYSQL_DATABASE: club_lujan
      MYSQL_USER: club
      MYSQL_PASSWORD: club
      MYSQL_ROOT_PASSWORD: root
      TZ: America/Argentina/Buenos_Aires
    command: --log-bin-trust-function-creators=1
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - ./mysql-data:/var/lib/mysql
      - ./backups:/backups
    restart: unless-stopped

  api:
    build: .
    container_name: talenttracker_api
    command: ["node", "src/server/index.js"]
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: club_lujan
      DB_USER: club
      DB_PASS: club
      DB_POOL: 10
      DB_AUDIT_DB: club_lujan
      JWT_SECRET: devsecret

      # EN PRODUCCIÓN ESTO DEBE SER EL DOMINIO REAL (lo ajustamos después)
      PUBLIC_BASE_URL: http://localhost:3000

      AI_BIOMETRIC_URL: http://biometric:8010/biometric
      AI_PERFORMANCE_URL: http://performance:8020/performance
    ports:
      - "3000:3000"
    depends_on:
      mysql:
        condition: service_healthy
      biometric:
        condition: service_started
      performance:
        condition: service_started
    volumes:
      - ./uploads:/app/uploads
    user: "0:0"
    restart: unless-stopped

  adminer:
    image: adminer:latest
    container_name: talenttracker_adminer
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: mysql
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  biometric:
    build:
      context: ..
      dockerfile: biometric_access/Dockerfile
    container_name: talenttracker_biometric
    environment:
      BIOMETRIC_MATCH_THRESHOLD: "0.92"
      BIOMETRIC_MAX_L2: "0.20"
    ports:
      - "8010:8010"
    restart: unless-stopped

  performance:
    build:
      context: ..
      dockerfile: performance_tracker/Dockerfile
    container_name: talenttracker_performance
    ports:
      - "8020:8020"
    volumes:
      - ../yolov8n-pose.pt:/app/yolov8n-pose.pt:ro
    restart: unless-stopped

  automation:
    build:
      context: .
      dockerfile: Dockerfile.automation
    container_name: talenttracker_automation
    environment:
      DB_HOST: mysql
      DB_USER: club
      DB_PASS: club
      MYSQL_ROOT_PASSWORD: root
      AUDIT_RETENTION_DAYS: 90
      TZ: America/Argentina/Buenos_Aires
    volumes:
      - ./backups:/backups
      - ./logs:/var/log/talenttracker
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  frontend:
    build: ../frontend
    container_name: talenttracker_frontend
    environment:
      # Lo que usa Axios en el navegador
      NEXT_PUBLIC_FRONT_API_PREFIX: /api/proxy

      # A dónde tiene que apuntar el proxy de Next dentro de la red Docker
      BACKEND_API_URL: http://api:3000   # si sus rutas son /auth/login
    ports:
      - "3001:3000"   # contenedor escucha 3000, host expone 3001
    depends_on:
      - api
    restart: unless-stopped
