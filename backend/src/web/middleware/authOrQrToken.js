import jwt from 'jsonwebtoken'; import authRequired from './authRequired.js';
export default function(roles=[]){const mw=authRequired(roles);return (req,res,next)=>{if(req.headers.authorization)return mw(req,res,next);const t=req.query.token||req.query.bearer;if(!t)return res.status(401).json({error:{message:'No autorizado'}});try{const p=jwt.verify(t,process.env.JWT_SECRET);if(String(p.pid)!==String(req.params.id))return res.status(403).json({error:{message:'Token no corresponde a la persona'}});req.user={id:0,rol_sistema:'PUBLIC_QR'};next();}catch{return res.status(401).json({error:{message:'Token invalido/expirado'}})}}}
