import jwt from 'jsonwebtoken';
export default function(roles=[]){return (req,res,next)=>{const h=req.headers.authorization||'';const m=h.match(/^Bearer\s+(.+)/i);if(!m)return res.status(401).json({error:{message:'No autorizado'}});try{const p=jwt.verify(m[1],process.env.JWT_SECRET);req.user=p;console.log('[authRequired] Usuario:', p.username, 'Rol:', p.rol_sistema, 'Roles permitidos:', roles);if(roles.length&&!roles.includes(p.rol_sistema)){console.log('[authRequired] ❌ RECHAZADO - Rol', p.rol_sistema, 'no está en', roles);return res.status(403).json({error:{message:'Sin permisos'}});}console.log('[authRequired] ✅ ACEPTADO');next();}catch(e){console.error('[authRequired] Error verificando token:', e.message);return res.status(401).json({error:{message:'Token invalido/expirado'}})}}}
