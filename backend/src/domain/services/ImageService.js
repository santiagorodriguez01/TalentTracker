import fs from 'fs/promises'; import path from 'path'; import { ensureDir } from '../utils/uploads.js';
export async function loadImageBuffer(src){if(!src)return null;try{if(/^https?:\/\//i.test(src)){const r=await fetch(src);if(!r.ok)return null;return Buffer.from(await r.arrayBuffer());}if(src.startsWith('/files/')){src=path.join('/app/uploads',src.replace(/^\/files\//,''));}return await fs.readFile(src);}catch{return null;}}
export async function saveWithSharp(srcPath,outDir){let sharp;try{sharp=(await import('sharp')).default;}catch{sharp=null;}await ensureDir(outDir);if(!sharp){await fs.copyFile(srcPath,path.join(outDir,'foto_600.jpg'));await fs.copyFile(srcPath,path.join(outDir,'thumb_200.jpg'));return;}await sharp(srcPath).rotate().resize(600,600,{fit:'cover'}).jpeg({quality:85}).toFile(path.join(outDir,'foto_600.jpg'));await sharp(srcPath).rotate().resize(200,200,{fit:'cover'}).jpeg({quality:80}).toFile(path.join(outDir,'thumb_200.jpg'));}
