'use client';
import React, { useRef, useEffect, useState } from 'react';
import { Box, Typography, Button, Card, CardContent, CircularProgress } from '@mui/material';
import VideocamRounded from '@mui/icons-material/VideocamRounded';
import { http } from '@/lib/http';
import { useIAStore } from '@/store/ia';
import { useRouter } from 'next/navigation';

export default function LivePerformancePage() {
  const selected = useIAStore(s => s.selectedAlumno);
  const router = useRouter();
  const videoRef = useRef<HTMLVideoElement>(null);
  const [streaming, setStreaming] = useState(false);
  const [analyzing, setAnalyzing] = useState(false);
  const [result, setResult] = useState<any>(null);
  const [countdown, setCountdown] = useState<number | null>(null);
  const [capturing, setCapturing] = useState(false);
  const [progress, setProgress] = useState(0);

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      if (videoRef.current) videoRef.current.srcObject = stream;
      setStreaming(true);
    } catch {
      alert('Error al acceder a la cámara.');
    }
  };

  const verifyAlumnoNow = async (): Promise<boolean> => {
    try {
      if (!selected?.id) return false;
      const blob = await captureFrameBlob();
      if (!blob) return false;
      const fd = new FormData();
      fd.append('image', blob);
      fd.append('challenge', 'blink');
      fd.append('evidence', JSON.stringify({ blink: true }));
      const res = await http.post(`/ai/alumnos/${selected.id}/verify-face`, fd);
      return !!res.data?.allow;
    } catch {
      return false;
    }
  };

  const captureFrameBlob = async (): Promise<Blob | null> => {
    if (!videoRef.current) return null;
    const canvas = document.createElement('canvas');
    canvas.width = videoRef.current.videoWidth;
    canvas.height = videoRef.current.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx?.drawImage(videoRef.current, 0, 0);
    return await new Promise<Blob | null>((resolve) => canvas.toBlob(resolve, 'image/jpeg'));
  };

  const startCountdownAndCapture = async () => {
    if (!streaming) return alert('Activa la cámara primero');
    if (!selected?.id) return alert('Seleccione un alumno primero');
    // Verificar enrolamiento biométrico
    try {
      const bio = await http.get(`/ai/alumnos/${selected.id}/biometric`);
      if (!bio.data?.enrolled) return router.replace('/ia/biometric');
    } catch { return router.replace('/ia/biometric'); }
    // Verificación del rostro del alumno
    setAnalyzing(true);
    const ok = await verifyAlumnoNow();
    setAnalyzing(false);
    if (!ok) { alert('No se pudo verificar el rostro del alumno.'); return; }
    // 3-2-1
    setResult(null);
    setCountdown(3);
    for (let t = 3; t > 0; t--) {
      setCountdown(t);
      await new Promise(r => setTimeout(r, 1000));
    }
    setCountdown(null);

    // Capturar durante 5s a ~10 FPS => 50 frames
    setCapturing(true);
    setAnalyzing(true);
    const frames = 50;
    for (let i = 0; i < frames; i++) {
      const blob = await captureFrameBlob();
      if (!blob) continue;
      const fd = new FormData();
      fd.append('frame', blob);
      fd.append('alumno_id', String(selected.id));
      try {
        const res = await http.post('/ai/performance/live', fd, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        setResult(res.data);
      } catch (err: any) {
        console.error(err);
      }
      setProgress(Math.round(((i + 1) / frames) * 100));
      await new Promise(r => setTimeout(r, 100)); // 10 FPS
    }
    setCapturing(false);
    setAnalyzing(false);
  };

  return (
    <Box sx={{ p: 2 }}>
      <Typography variant="h5" fontWeight={700} mb={2}>
        Monitoreo en Vivo
      </Typography>
      <Card variant="outlined" sx={{ maxWidth: 700, mx: 'auto' }}>
        <CardContent sx={{ display: 'grid', gap: 2 }}>
          <video ref={videoRef} autoPlay muted playsInline style={{ width: '100%', borderRadius: 8 }} />
          <Button
            startIcon={<VideocamRounded />}
            onClick={startCamera}
            variant="contained"
            color="primary"
            disabled={streaming}
          >
            {streaming ? 'Cámara activa' : 'Iniciar cámara'}
          </Button>

          <Button onClick={startCountdownAndCapture} variant="outlined" disabled={!streaming || analyzing}>
            {analyzing ? <CircularProgress size={22} /> : (capturing ? `Grabando... ${progress}%` : 'Grabar 5s y analizar')}
          </Button>

          {countdown !== null && (
            <Box sx={{ position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
              <Typography variant="h2" fontWeight={900}>{countdown}</Typography>
            </Box>
          )}

          {result && (
            <Box sx={{ mt: 2 }}>
              <Typography variant="subtitle1">Resultado:</Typography>
              <Typography variant="body2" color="text.secondary">
                {JSON.stringify(result, null, 2)}
              </Typography>
            </Box>
          )}
        </CardContent>
      </Card>
    </Box>
  );
}

